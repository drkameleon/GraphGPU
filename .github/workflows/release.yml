name: Release

on:
    push:
        tags:
            - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
    contents: write

jobs:
    release:
        name: Build
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Type-check
              run: npx tsc --noEmit

            - name: Build ES modules
              run: npm run build

            - name: Bundle standalone UMD files
              run: |
                  npx esbuild src/index.ts \
                      --bundle \
                      --format=iife \
                      --global-name=GraphGPU \
                      --target=es2022 \
                      --outfile=dist/graphgpu.standalone.js \
                      --footer:js="if(typeof module!=='undefined')module.exports=GraphGPU;"

                  npx esbuild src/index.ts \
                      --bundle \
                      --format=iife \
                      --global-name=GraphGPU \
                      --target=es2022 \
                      --minify \
                      --outfile=dist/graphgpu.standalone.min.js \
                      --footer:js="if(typeof module!=='undefined')module.exports=GraphGPU;"

                  echo "Standalone sizes:"
                  ls -lh dist/graphgpu.standalone.js dist/graphgpu.standalone.min.js

            - name: Extract version from tag
              id: version
              run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  name: v${{ steps.version.outputs.version }}
                  generate_release_notes: true
                  files: |
                      dist/graphgpu.standalone.js
                      dist/graphgpu.standalone.min.js
